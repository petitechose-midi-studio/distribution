name: Nightly

on:
  schedule:
    - cron: "17 3 * * *"
  workflow_dispatch: {}

permissions:
  contents: read

jobs:
  select_spec:
    runs-on: ubuntu-latest
    outputs:
      should_publish: ${{ steps.select.outputs.should_publish }}
      tag: ${{ steps.tag.outputs.tag }}
    steps:
      - name: Checkout distribution
        uses: actions/checkout@v4

      - name: Compute tag
        id: tag
        shell: bash
        run: |
          set -euo pipefail
          echo "tag=nightly-$(date -u +%Y-%m-%d)" >> "$GITHUB_OUTPUT"

      - name: Select latest green SHAs
        id: select
        shell: bash
        env:
          GITHUB_TOKEN: ${{ github.token }}
        run: |
          set -euo pipefail
          mkdir -p out
          set +e
          python scripts/select_latest_green.py --template release-specs/nightly.template.json --out out/release-spec.json --tag "${{ steps.tag.outputs.tag }}"
          RC=$?
          set -e

          if [ "$RC" -eq 0 ]; then
            echo "should_publish=1" >> "$GITHUB_OUTPUT"
          elif [ "$RC" -eq 2 ]; then
            echo "should_publish=0" >> "$GITHUB_OUTPUT"
            exit 0
          else
            exit "$RC"
          fi

      - name: Upload spec
        if: steps.select.outputs.should_publish == '1'
        uses: actions/upload-artifact@v4
        with:
          name: nightly-release-spec
          path: out/release-spec.json

  build_bundles:
    name: Build bundles (${{ matrix.bundle_os }}-${{ matrix.arch }})
    needs: [select_spec]
    if: needs.select_spec.outputs.should_publish == '1'
    runs-on: ${{ matrix.runner }}
    strategy:
      fail-fast: false
      matrix:
        include:
          - runner: windows-latest
            rust_target: x86_64-pc-windows-msvc
            bundle_os: windows
            arch: x86_64
            exe: .exe
          - runner: ubuntu-latest
            rust_target: x86_64-unknown-linux-gnu
            bundle_os: linux
            arch: x86_64
            exe: ""
          - runner: macos-15-intel
            rust_target: x86_64-apple-darwin
            bundle_os: macos
            arch: x86_64
            exe: ""
          - runner: macos-latest
            rust_target: aarch64-apple-darwin
            bundle_os: macos
            arch: arm64
            exe: ""

    steps:
      - name: Checkout distribution
        uses: actions/checkout@v4

      - name: Download release spec
        uses: actions/download-artifact@v4
        with:
          name: nightly-release-spec
          path: spec

      - name: Read release spec
        id: spec
        shell: bash
        run: |
          set -euo pipefail
          python - <<'PY' >> "$GITHUB_OUTPUT"
          import json

          spec = json.load(open('spec/release-spec.json', 'r', encoding='utf-8'))
          repos = {r['id']: r['sha'] for r in spec['repos']}
          print(f"loader_sha={repos['loader']}")
          print(f"bridge_sha={repos['oc-bridge']}")
          PY

      - name: Checkout loader
        uses: actions/checkout@v4
        with:
          repository: petitechose-midi-studio/loader
          ref: ${{ steps.spec.outputs.loader_sha }}
          path: src/loader

      - name: Checkout oc-bridge
        uses: actions/checkout@v4
        with:
          repository: open-control/bridge
          ref: ${{ steps.spec.outputs.bridge_sha }}
          path: src/oc-bridge

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: ${{ matrix.rust_target }}

      - name: Cache
        uses: Swatinem/rust-cache@v2

      - name: Install Linux system deps
        if: matrix.bundle_os == 'linux'
        shell: bash
        run: |
          set -euo pipefail
          sudo apt-get update
          sudo apt-get install -y libudev-dev libusb-1.0-0-dev

      - name: Build loader
        shell: bash
        run: |
          set -euo pipefail
          cargo build --release --target "${{ matrix.rust_target }}"
        working-directory: src/loader

      - name: Build oc-bridge
        shell: bash
        run: |
          set -euo pipefail
          cargo build --release --target "${{ matrix.rust_target }}"
        working-directory: src/oc-bridge

      - name: Package bundle
        shell: bash
        run: |
          set -euo pipefail
          mkdir -p dist
          LOADER="src/loader/target/${{ matrix.rust_target }}/release/midi-studio-loader${{ matrix.exe }}"
          BRIDGE="src/oc-bridge/target/${{ matrix.rust_target }}/release/oc-bridge${{ matrix.exe }}"
          test -f "$LOADER"
          test -f "$BRIDGE"
          OUT="dist/midi-studio-${{ matrix.bundle_os }}-${{ matrix.arch }}-bundle.zip"
          python scripts/package_bundle.py --out "$OUT" --loader "$LOADER" --oc-bridge "$BRIDGE" --oc-bridge-config "src/oc-bridge/config"

      - name: Upload bundle
        uses: actions/upload-artifact@v4
        with:
          name: midi-studio-${{ matrix.bundle_os }}-${{ matrix.arch }}-bundle
          path: dist/midi-studio-${{ matrix.bundle_os }}-${{ matrix.arch }}-bundle.zip

  release:
    runs-on: ubuntu-latest
    needs: [select_spec, build_bundles]
    if: needs.select_spec.outputs.should_publish == '1'
    environment: nightly
    permissions:
      contents: write
    steps:
      - name: Checkout distribution
        uses: actions/checkout@v4

      - name: Download bundles
        uses: actions/download-artifact@v4
        with:
          path: dist

      - name: Download release spec
        uses: actions/download-artifact@v4
        with:
          name: nightly-release-spec
          path: spec

      - name: Flatten artifacts
        shell: bash
        run: |
          set -euo pipefail
          mkdir -p dist_flat
          find dist -maxdepth 3 -type f -name '*.zip' -print -exec cp '{}' dist_flat/ \;

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Cache
        uses: Swatinem/rust-cache@v2

      - name: Build manifest
        shell: bash
        run: |
          set -euo pipefail
          cargo run -p ms-dist-manifest -- build --spec spec/release-spec.json --dist dist_flat --out manifest.json

      - name: Sign manifest (nightly)
        shell: bash
        env:
          MS_DIST_ED25519_SK: ${{ secrets.MS_DIST_ED25519_SK_NIGHTLY }}
        run: |
          set -euo pipefail
          cargo run -p ms-dist-manifest -- sign --in manifest.json --out manifest.json.sig

      - name: Create GitHub Release
        shell: bash
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          set -euo pipefail
          gh release create "${{ needs.select_spec.outputs.tag }}" \
            dist_flat/*.zip \
            manifest.json manifest.json.sig \
            --title "${{ needs.select_spec.outputs.tag }}" \
            --notes "channel=nightly" \
            --prerelease \
            --repo "${GITHUB_REPOSITORY}"
